# Спецификация Flow 4 Telegram-бота (Начало для реферала 2)

## 0) Карта спецификаций
- Flow 1: `/Users/islam/IdeaProjects/Tajwid/startingSpec.md`
  Базовая (нереферальная) регистрация.
- Flow 2: `/Users/islam/IdeaProjects/Tajwid/refFlowSpec.md`
  Выдача персональной реферальной ссылки пользователю-рефереру.
- Flow 3: `/Users/islam/IdeaProjects/Tajwid/referralStartSpec.md`
  Старт реферальной ветки для приглашённого (подписка + согласие).
- Flow 4 (этот документ): `/Users/islam/IdeaProjects/Tajwid/referralStart2Spec.md`
  Продолжение регистрации приглашённого после запуска `Следующий шаг`.
- Flow 5: `/Users/islam/IdeaProjects/Tajwid/referralEndSpec.md`
  Конечное начисление и учёт баллов за приглашённых.

## 1) Область сценария
Этот документ описывает сценарий `Начало для реферала 2` по схеме заказчика:
- фиксация Telegram-профиля приглашённого (`user_id`, `first_name`) через Telegram Update/API;
- сбор реального имени приглашённого (`user_name`);
- сбор возраста приглашённого;
- сбор данных о детях (факт наличия детей + факт изучения Корана, если дети есть);
- сбор телефона;
- сегментация по уровню чтения;
- подтверждение регистрации;
- автоматическая отправка Flow 2 (`Продолжение реф`) не ранее чем через ~3 минуты после завершения регистрации и только после подтверждения подписки на канал курса;
- фоновая обработка перехода приглашённого в канал курса для начисления балла в Flow 5 (`Конец`).

## 2) Связь с Flow 3
Вход в Flow 4 выполняется из Flow 3 по действию:
`Запустить автоматизацию -> Следующий шаг`.

Контекст на входе:
- пользователь уже прошёл блок согласия;
- пользователь находится в реферальной ветке приглашённого;
- из Flow 3 переданы `referrer_user_id` и `invitee_user_id`.

Выход из Flow 4:
- пользователю автоматически отправляется Flow 2 (`/Users/islam/IdeaProjects/Tajwid/refFlowSpec.md`) после проверки подписки на канал курса (не ранее чем через ~3 минуты после завершения регистрации);
- начисление балла пригласившему выполняется отдельным фоновым триггером через Flow 5 (`/Users/islam/IdeaProjects/Tajwid/referralEndSpec.md`) после подтверждения подписки приглашённого на канал курса.

## 3) Основной сценарий (по схеме "Начало для реферала 2")

### Шаг 0. Фиксация Telegram-профиля (служебно)
До ввода анкеты получить через Telegram API:
- `invitee_user_id` = `from.id` (стабильный идентификатор приглашённого);
- `telegram_first_name` = `from.first_name`.

Источник данных:
- при входящем сообщении брать из `update.message.from`;
- при необходимости обновить позже использовать `getChat(chat_id = invitee_user_id)`.

Сохранить во временный контекст сценария.
Запись в таблице пользователей (`users`) на этом шаге не создавать.

Проверки:
- `invitee_user_id` обязателен и уникален.

### Шаг 1. Запрос имени
Отправить сообщение:
`Отлично, продолжаем регистрацию.`
`Укажите ваше имя, пожалуйста.`

### Шаг 2. Сбор имени (`user_name`)
Действие: `Сбор данных контакта (Текст)`.

Ожидать текстовый ввод и применить валидацию имени:
- строка от 2 до 50 символов;
- допускаются буквы, пробел и дефис;
- цифры и спецсимволы не допускаются.

Если имя валидно:
- сохранить в `{{name}}`;
- сохранить в поле `user_name`;
- переход к шагу 3.

Если имя невалидно:
- показать сообщение:
  `Пожалуйста, укажите корректное имя (2-50 символов, только буквы, пробел, дефис).`
- повторить шаг 2.

### Шаг 3. Сбор возраста
Отправить сообщение:
`Укажите ваш возраст, пожалуйста.`

Ожидать ввод возраста и применить валидацию:
- только целое число;
- диапазон от 7 до 100 лет.

Если возраст валиден:
- сохранить в `{{age}}`;
- переход к шагу 4.

Если возраст невалиден:
- показать сообщение:
  `Пожалуйста, укажите корректный возраст числом от 7 до 100.`
- повторить шаг 3.

### Шаг 4. Блок про детей: только факт наличия детей
После успешной валидации возраста отправить сообщения:
- `Рад знакомству, {{name}}, идем дальше.`
- `Есть ли у вас дети?`

Кнопки:
- `Да`
- `Нет`

Если выбран ответ `Да`:
- сохранить `{{has_children}} = true`;
- переход к шагу 5.

Если выбран ответ `Нет`:
- сохранить `{{has_children}} = false`;
- `{{children_study_quran}} = null`;
- переход к шагу 6.

Если ввод невалидный:
- показать сообщение об ошибке;
- повторить шаг 4.

### Шаг 5. Вопрос по детям: изучают ли Коран
Логика шага выполняется только если `has_children = true`.

Отправить вопрос:
`Изучают ли они Коран?`

Кнопки:
- `Да`
- `Нет`

Поведение:
- при выборе `Да` сохранить `{{children_study_quran}} = true`, переход к шагу 6;
- при выборе `Нет` сохранить `{{children_study_quran}} = false`, переход к шагу 6;
- если пользователь вводит текст вместо кнопки, допускается `да/нет` (без учёта регистра);
- при любом другом вводе показать:
  `Пожалуйста, выберите один из вариантов ниже.`
  и повторно показать кнопки `Да` / `Нет`.

### Шаг 6. Сбор телефона
Действие: `Запросить номер телефона` через кнопку `ReplyKeyboardMarkup` с `request_contact = true`.

После получения `message.contact`:
- проверить, что `contact.user_id == invitee_user_id`;
- сохранить `contact.phone_number` в `{{phone}}`.

Если `contact.user_id != invitee_user_id`:
- показать сообщение:
  `Пожалуйста, отправьте ваш собственный номер через кнопку в боте.`
- повторить шаг 6.

### Шаг 7. Сегментация по уровню чтения
Отправить сообщение:
`Какой у вас текущий уровень чтения Корана?`

Варианты:
- `Начинаю с нуля`
- `Читаю по слогам`
- `Знаю основы`
- `Читаю с ошибками`
- `Читаю уверенно`

На каждый вариант выполнить действие `Добавить теги` с одноимённым тегом.
Дополнительно сохранить выбранный вариант в поле `reading_level`.

### Шаг 8. Подтверждение регистрации
Перед отправкой сообщения о регистрации:
- создать запись пользователя в `users` (или выполнить `upsert`) с полным набором данных;
- заполнить в записи:
  - `user_id = invitee_user_id`;
  - `telegram_first_name`, `telegram_username`;
  - `user_name`, `age`, `has_children`, `children_study_quran`, `phone`, `reading_level`;
  - `is_school_channel_subscribed = true`;
  - `is_course_channel_subscribed = false`;
  - `consent_given = true`;
  - `registration_completed = true`;
  - `registration_completed_at = now()`;
  - `referrer_user_id` (из контекста Flow 3);
  - `referral_status = pending`;
  - `referral_counted_at = 1970-01-01T00:00:00Z`;
  - `referral_points = 0`.

Отправить сообщение:
`Вы успешно зарегистрированы на курс по таджвиду!`
`Вся информация о занятиях, ссылки и материалы будут публиковаться в Telegram-канале.`
`Подпишитесь на канал курса.`

Дополнительно:
- отправить служебное уведомление администратору о новой регистрации;
- состав уведомления: имя, возраст, `telegram_username`, телефон, факт наличия детей, уровень чтения, кто пригласил (если есть).

Кнопка:
- `Канал по курсу`.

После этого шага:
- отдельной кнопки `Проверить подписку` нет;
- Flow 2 отправляется автоматически не ранее чем через ~3 минуты и только после подтверждения подписки;
- подтверждение подписки на канал курса проверяется в фоне (membership update и/или периодический re-check).

### Шаг 9. Фоновая пост-обработка после перехода в канал курса
Событие: бот подтверждает подписку приглашённого на канал курса (без дополнительного действия пользователя).

Каноничная логика:
- сформировать и передать контракт в Flow 5 (`Конец`);
- запустить автоматизацию Flow 5 (`Конец`) для начисления `+1` пригласившему;
- после завершения Flow 5 получить результат `is_already_counted`:
  - `true`: балл засчитан для сущности реферальной ссылки, продолжить в Flow 2;
  - `false`: балл не засчитан, зафиксировать аномалию.

Важно:
- запуск/доставка Flow 2 не зависит от результата шага 9;
- Flow 2 уже запланирован автоматически после шага 8, но отправляется только при подтверждённой подписке на канал курса.

Важное уточнение:
- отдельный технический тег не используется;
- защита от повторного зачёта обеспечивается идемпотентностью Flow 5 (`idempotency_key` и уникальность события в БД);
- начисление баллов происходит только в Flow 5.

## 4) Спецификация данных

### 4.1 Переменные
- `{{name}}` — реальное имя приглашённого пользователя (`user_name`);
- `{{telegram_first_name}}` — `first_name` приглашённого из Telegram API (шаг 0);
- `{{age}}` — возраст приглашённого пользователя;
- `{{has_children}}` — ответ `Да/Нет` из шага 4;
- `{{children_study_quran}}` — ответ `Да/Нет` из шага 5;
- `{{phone}}` — телефон приглашённого пользователя из шага 6.

### 4.2 Теги
- `Начинаю с нуля`
- `Читаю по слогам`
- `Знаю основы`
- `Читаю с ошибками`
- `Читаю уверенно`

### 4.3 Контракт запуска Flow 5 (обязательный payload)
Flow 4 перед запуском Flow 5 передаёт:
- `referral_event_id` — UUID события начисления;
- `referrer_user_id` — из контекста Flow 3;
- `invitee_user_id` — текущий пользователь (приглашённый);
- `idempotency_key` — строка формата `ref:{referrer_user_id}:{invitee_user_id}`;
- `trigger_source` — одно из значений:
  - `flow4_course_link_click` (ручная проверка);
  - `course_channel_membership_update` (авто-подтверждение подписки по membership update);
- `triggered_at` — timestamp запуска Flow 5.

Правила:
- без полного payload Flow 5 не запускать;
- `idempotency_key` должен быть детерминированным для пары `(referrer_user_id, invitee_user_id)`;
- при повторном входе в шаг 9 использовать тот же `idempotency_key`.

### 4.4 Единая карточка пользователя (единый состав полей)
Для реферальной ветки использовать тот же состав полей, что и в обычной регистрации (Flow 1):
- `user_id` (обязательное, уникальное; это `Telegram user.id`, основной идентификатор);
- `telegram_first_name` (из Telegram профиля на шаге 0);
- `telegram_username` (если доступен из Telegram Update);
- `user_name` (реальное имя пользователя, вводится на шаге 2);
- `age` (возраст пользователя);
- `has_children` (bool, ответ шага 4);
- `children_study_quran` (bool, ответ шага 5; `null` при `has_children = false`);
- `phone` (номер телефона из шага 6);
- `is_school_channel_subscribed` (bool);
- `is_course_channel_subscribed` (bool);
- `consent_given` (bool);
- `registration_completed` (bool);
- `registration_completed_at` (timestamp, NOT NULL; до завершения регистрации хранить `1970-01-01T00:00:00Z`);
- `reading_level` (одно из 5 значений шага 7);
- `referrer_user_id` (NOT NULL; `0` означает отсутствие реферера);
- `referral_status` (`pending` | `counted` | `not_applicable`);
- `referral_counted_at` (timestamp, NOT NULL; до зачёта хранить `1970-01-01T00:00:00Z`);
- `referral_points` (int, по умолчанию `0`);
- `created_at`, `updated_at`.

Правило создания записи:
- запись пользователя создаётся после завершения анкеты (имя, возраст, данные по детям, телефон, уровень чтения) на шаге 8;
- до шага 8 данные хранятся только во временном контексте сценария.

Для реферального пути (Flow 3 -> Flow 4):
- `referrer_user_id` заполняется из параметра `/start <referrer_user_id>`;
- до выполнения Flow 5 устанавливать `referral_status = pending`;
- после Flow 5:
  - при `is_already_counted = true` переводить `referral_status = counted` и заполнять `referral_counted_at = now()`;
  - при `is_already_counted = false` статус оставлять `pending` до ручной обработки.

## 5) Крайние случаи и замечания по схеме
- Если в конструкторе остаётся промежуточный условный блок, он не должен содержать бизнес-проверок.
- В реализации не использовать "двойной `Следующий шаг` в никуда"; использовать два осмысленных запуска:
  - сначала Flow 5 (`Конец`);
  - затем Flow 2 (`Продолжение реф`).
- Сценарий `is_already_counted = false` в норме не должен происходить, но должен быть обработан безопасно:
  - не считать это фатальной ошибкой для пользователя;
  - всё равно продолжать в Flow 2;
  - фиксировать как аномалию в мониторинге.
- Пользователь отправил некорректное имя:
  показывать сообщение об ошибке валидации и повторять шаг 2.
- Пользователь отправил некорректный ответ на вопрос `Есть ли у вас дети?`:
  показывать сообщение об ошибке валидации и повторять шаг 4.
- Пользователь отправил некорректный ответ на вопрос `Изучают ли они Коран?`:
  повторно показывать кнопки `Да` / `Нет` на шаге 5.
- Пользователь отправил чужой контакт (`contact.user_id != invitee_user_id`):
  отклонять контакт и повторять шаг 6.

## 6) Граница текущего ТЗ
Flow 4 после шага 8 порождает две независимые ветки:
1. автоматическая отправка пользователю Flow 2 (`/Users/islam/IdeaProjects/Tajwid/refFlowSpec.md`) не ранее чем через ~3 минуты и только после подтверждения подписки на канал курса;
2. фоновый запуск Flow 5 (`/Users/islam/IdeaProjects/Tajwid/referralEndSpec.md`) при подтверждении подписки приглашённого на канал курса.

Контракт вызова Flow 5 определяется разделом `4.3` этого документа.
