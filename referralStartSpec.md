# Спецификация Flow 3 Telegram-бота (Начало для реферала)

## 0) Карта спецификаций
- Flow 1: `/Users/islam/IdeaProjects/Tajwid/startingSpec.md`
  Базовая (нереферальная) регистрация.
- Flow 2: `/Users/islam/IdeaProjects/Tajwid/refFlowSpec.md`
  Выдача персональной реферальной ссылки пользователю-рефереру.
- Flow 3 (этот документ): `/Users/islam/IdeaProjects/Tajwid/referralStartSpec.md`
  Старт реферальной ветки для приглашённого пользователя.
- Flow 4: `/Users/islam/IdeaProjects/Tajwid/referralStart2Spec.md`
  Продолжение регистрации приглашённого после запуска `Следующий шаг`.
- Flow 5: `/Users/islam/IdeaProjects/Tajwid/referralEndSpec.md`
  Финальное начисление и учёт баллов за приглашённых.

## 1) Область сценария
Этот документ описывает только первый этап реферальной ветки для приглашённого пользователя (invitee), который приходит по реферальной ссылке.

Что входит в Flow 3:
- вход приглашённого по параметру `/start <referrer_user_id>`;
- валидация и фиксация `referrer_user_id` в контексте приглашённого;
- фиксация технического контекста приглашённого по `invitee_user_id` (без создания пользовательской карточки);
- анти-повторная проверка использования реферальной ссылки;
- проверка подписки на общий Telegram-канал школы;
- согласие на обработку персональных данных;
- запуск следующей автоматизации (`Следующий шаг`).

Что не входит в Flow 3:
- фиксация `telegram_first_name` через Telegram API, сбор `user_name`/возраста/телефона и сегментация приглашённого (это Flow 4);
- выдача персональной реферальной ссылки рефереру (это Flow 2);
- нереферальная регистрация пользователя (это Flow 1).

## 2) Логическая связь пяти спецификаций
- Flow 2 генерирует ссылку `https://t.me/<bot_username>?start=<referrer_user_id>`.
- Flow 3 принимает `referrer_user_id` и проводит приглашённого через входной блок.
- Flow 3 запускает `Следующий шаг`, который является входом в Flow 4.
- Flow 4 после регистрации приглашённого запускает Flow 5 (`Конец`) для начисления `+1` пригласившему.
- После Flow 5 из Flow 4 запускается Flow 2 (`Продолжение реф`), чтобы выдать уже новому участнику его персональную ссылку.

## 3) Точка входа
Триггер: `/start <referrer_user_id>` для приглашённого пользователя.

## 4) Основной сценарий (по схеме "Начало для реферала")

### Шаг 0. Валидация и фиксация реферального контекста
На входе разобрать параметр `/start <referrer_user_id>` и выполнить проверки:
- параметр присутствует и корректно парсится;
- `referrer_user_id` существует в системе;
- `referrer_user_id != invitee_user_id` (запрет самореферала).

Далее выполнить служебную фиксацию контекста (без создания карточки пользователя):
- определить `invitee_user_id` из Telegram Update;
- записать в технический контекст сценария пару (`referrer_user_id`, `invitee_user_id`);
- в таблицу пользователей (`users`) на этом шаге запись не создавать.

Если проверка не пройдена:
- показать сообщение о невозможности использовать текущую реферальную ссылку;
- завершить сценарий без записи битого `referrer_user_id` в БД.

Если проверка пройдена:
- сохранить `referrer_user_id` в технический контекст приглашённого (не в `users`);
- продолжить к шагу 1.

### Шаг 1. Проверка анти-повтора по реферальной ссылке
Проверка выполняется через БД по `invitee_user_id`.

Назначение шага:
- не дать приглашённому повторно пройти этот же реферальный вход;
- не допустить повторный зачёт одного и того же приглашённого.

Каноничная проверка:
- наличие для `invitee_user_id` уже обработанного реферального состояния:
  - `referral_status = pending` или `referral_status = counted`;
  - или существующая запись в `referral_link_usage` для этого приглашённого.

Если `TRUE`:
- отправить сообщение:
  `Вы больше не можете использовать эту ссылку.`
- завершить текущий сценарий.

Если `FALSE`:
- переход к шагу 2.

### Шаг 2. Сообщение о приглашении и подписке на общий канал
Отправить сообщение:
`Ассаламу алейкум ва рахматуЛлахи ва баракатух!`
`Ваш друг позаботился о вас и пригласил на наш курс по таджвиду.`
`Для участия необходимо сначала подписаться на наш Telegram-канал.`
`Пожалуйста, подпишитесь на канал и затем нажмите кнопку ниже для продолжения регистрации.`

Кнопки:
- `Подписался`;
- `Telegram канал` (ссылка на общий канал школы).

Переход к шагу 3.

### Шаг 3. Проверка события после нажатия кнопки
После нажатия кнопки `Подписался` выполнить проверку через БД:
- найти технический контекст приглашённого по `invitee_user_id`;
- убедиться, что контекст доступен для продолжения сценария.

Если `TRUE`:
- добавить тег `Нажал на кнопку подписался`;
- переход к шагу 4.

Если `FALSE`:
- ждать корректного события от пользователя.

### Шаг 4. Повторная проверка подписки на общий канал
Системное условие: `Подписка`.

Если `TRUE`:
- добавить тег `Подписка с бота`;
- переход к шагу 5.

Если `FALSE`:
- отправить сообщение:
  `Возможно, подписка ещё не оформилась.`
  `Пожалуйста, подпишитесь на Telegram-канал и затем нажмите кнопку снова.`
- кнопка: `Готово`;
- повторная проверка выполняется после кнопки `Готово`.

### Шаг 5. Согласие на обработку персональных данных
Отправить сообщение:
`Пусть Аллах облегчит вам обучение.`
`Продолжая работу с ботом, вы даете согласие на обработку персональных данных.`

Кнопка:
- `Продолжить`.

Поведение:
- без нажатия `Продолжить` переход дальше недоступен;
- при нажатии `Продолжить` выполнить действие:
  `Запустить автоматизацию -> Следующий шаг`.

## 5) Спецификация данных

### 5.1 Входные данные
- `referrer_user_id` (из параметра `/start`).
- `invitee_user_id` (текущий пользователь Telegram).

### 5.2 Выходной контекст в Flow 4
Перед запуском Flow 4 должны быть доступны:
- `referrer_user_id` (валидированный, сохранённый в техническом контексте шага 0);
- `invitee_user_id`;
- `referral_entry_source = referral_link`;
- `referral_entry_at` (timestamp фиксации входа).

### 5.3 Теги
- `Нажал на кнопку подписался`;
- `Подписка с бота`.

## 6) Крайние случаи
- По БД уже есть активное/завершённое реферальное состояние приглашённого:
  показать сообщение о невозможности повторного использования ссылки и завершить сценарий без перехода в Flow 4/5.
- По `invitee_user_id` не удалось записать/прочитать технический реферальный контекст:
  показать техническое сообщение и остановить сценарий до ручного повтора.
- Пользователь не подтвердил подписку на общий канал:
  повторять проверку только по кнопке `Готово`.
- Пользователь не нажал `Продолжить` на согласии:
  переход в Flow 4 недоступен.

## 7) Граница текущего ТЗ
Flow 3 завершается запуском автоматизации `Следующий шаг`.
Подробная спецификация продолжения вынесена в:
- `/Users/islam/IdeaProjects/Tajwid/referralStart2Spec.md`.
