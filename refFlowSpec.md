# Спецификация Flow 2 Telegram-бота (Продолжение реф)

## 0) Карта спецификаций
- Flow 1: `/Users/islam/IdeaProjects/Tajwid/startingSpec.md`
  Базовая (нереферальная) регистрация.
- Flow 2 (этот документ): `/Users/islam/IdeaProjects/Tajwid/refFlowSpec.md`
  Выдача персональной реферальной ссылки пользователю-рефереру.
- Flow 3: `/Users/islam/IdeaProjects/Tajwid/referralStartSpec.md`
  Обработка приглашённого пользователя по ссылке из Flow 2.
- Flow 4: `/Users/islam/IdeaProjects/Tajwid/referralStart2Spec.md`
  Продолжение регистрации приглашённого после Flow 3.
- Flow 5: `/Users/islam/IdeaProjects/Tajwid/referralEndSpec.md`
  Финальное начисление и учёт баллов за приглашённых.

## 1) Область сценария
Этот документ описывает Flow 2 (`Продолжение реф`): выдача пользователю его персональной реферальной ссылки и правила повторного показа ссылки.

Что входит в Flow 2:
- сообщение о реферальной программе;
- сообщение с условиями участия;
- проверка, выдавалась ли пользователю ссылка ранее;
- генерация и сохранение персональной ссылки (при первом показе);
- повторный показ уже сохранённой ссылки (при повторном входе).

Что не входит в Flow 2:
- логика зачёта рефералов за приглашённых пользователей;
- проверка подписки приглашённых на канал курса;
- расчёт рейтинга победителя.

## 2) Связь с другими Flow
Вход в Flow 2 может выполняться из двух точек:
- из Flow 1 после завершения регистрации (обычный нереферальный путь);
- из Flow 4 после шага начисления балла в Flow 5 (путь приглашённого, который стал новым участником программы).

Точка стыка:
- входные данные: карточка текущего пользователя (регистрация уже завершена в Flow 1 или Flow 4);
- выходные данные: у пользователя есть сохранённая персональная реферальная ссылка `{{referral_link_CP}}`.

Контракт на формат ссылки (синхронно с Flow 1 и Flow 4):
- реферальная ссылка должна приводить к запуску бота с параметром в формате `/start <referrer_user_id>`;
- для текущего пользователя `referrer_user_id = user_id` этого пользователя;
- web-форма deep-link: `https://t.me/<bot_username>?start=<referrer_user_id>`.

## 3) Основной сценарий

### Шаг 1. Сообщение о реферальной программе
Отправить сообщение (по схеме):
`Вы записались — альхамдулиллях.`
`Теперь приглашайте друзей и получайте награду за каждого.`
`Нажмите кнопку ниже, чтобы узнать условия и получить свою ссылку.`

Кнопка:
- `Условия`.

Переход к шагу 2 по кнопке `Условия`.

### Шаг 2. Сообщение с условиями участия
Отправить сообщение с условиями (по схеме), включая:
- у пользователя персональная ссылка;
- зачёт приглашения только после того, как друг перейдёт по ссылке, завершит регистрацию и выполнит шаг перехода в канал курса (дальнейшая фиксация выполняется в Flow 4 -> Flow 5);
- разрешённые каналы распространения ссылки;
- запрет фейковых аккаунтов и ботов;
- предупреждение об аннулировании участия при нарушениях.

Кнопка:
- `А вот и ваша ссылка`.

Переход к шагу 3 по кнопке `А вот и ваша ссылка`.

### Шаг 3. Проверка, выдавалась ли ссылка ранее
Системное условие: `Назначенные теги` с проверкой тега `Рефер получил ссылку`.

Если условие `TRUE` (тег уже есть):
- переход к шагу 5 (показ ссылки из переменной).

Если условие `FALSE` (тега нет):
- переход к шагу 4 (первичная генерация ссылки).

### Шаг 4. Первичная выдача ссылки
Последовательность действий:
1. Добавить тег `Рефер получил ссылку`.
2. Выполнить действие `Реферальная ссылка -> Сохранить в переменную`.
3. Сохранить ссылку в `{{referral_link_CP}}` в формате:
   `https://t.me/<bot_username>?start=<referrer_user_id>`.

Переход к шагу 5.

### Шаг 5. Показ персональной ссылки
Отправить сообщение:
`{{referral_link_CP}}`

Переход к шагу 6.

### Шаг 6. Финальное сообщение
Отправить сообщение:
`Выше ваша пригласительная ссылка.`
`Начинайте прямо сейчас и приводите братьев к благу.`

## 4) Спецификация данных

### 4.1 Поля/данные пользователя
Для пользователя применяется единая карточка данных (как в Flow 1, раздел 5.1 в `/Users/islam/IdeaProjects/Tajwid/startingSpec.md`).

Дополнительно для Flow 2 обязательно:
- `referral_link_CP` (персональная реферальная ссылка).

### 4.2 Теги
- `Рефер получил ссылку`.

### 4.3 Переменные сценария
- `{{referral_link_CP}}` — персональная реферальная ссылка пользователя.
  Формат: `https://t.me/<bot_username>?start=<referrer_user_id>`.

## 5) Крайние случаи и ожидаемое поведение
- Тег `Рефер получил ссылку` есть, но `{{referral_link_CP}}` пустая:
  повторно выполнить действие генерации и сохранить ссылку, затем показать пользователю.
- Ошибка при генерации ссылки:
  показать сообщение о временной ошибке и кнопку `Попробовать снова`.
  По нажатию `Попробовать снова` повторить шаг 5 (ручной retry, без автоповтора).
- Пользователь повторно проходит Flow 2:
  повторно показывать уже сохранённую ссылку, без генерации нового идентификатора.
- Пользователь нажимает кнопки повторно:
  сценарий не должен создавать дубликаты тегов и новых ссылок.

## 6) Критерии соответствия схеме
Сценарий должен содержать узлы, соответствующие схеме:
1. `Сообщение` с кнопкой `Условия`.
2. `Сообщение` с условиями и кнопкой `А вот и ваша ссылка`.
3. `Условие: Назначенные теги`.
4. Ветка первичного входа: `Добавить теги` -> `Реферальная ссылка: Сохранить в переменную`.
5. `Сообщение` с переменной `{{referral_link_CP}}`.
6. Финальное `Сообщение` о том, что выше пригласительная ссылка.

## 7) Граница текущего ТЗ
Flow 2 завершается выдачей персональной ссылки `{{referral_link_CP}}`.
Дальнейшая обработка приглашённого пользователя по этой ссылке описана в:
- `/Users/islam/IdeaProjects/Tajwid/referralStartSpec.md` (входной этап);
- `/Users/islam/IdeaProjects/Tajwid/referralStart2Spec.md` (этап продолжения регистрации);
- `/Users/islam/IdeaProjects/Tajwid/referralEndSpec.md` (конечное начисление и сохранение баллов в БД).
