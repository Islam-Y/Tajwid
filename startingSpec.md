# Спецификация Flow 1 Telegram-бота (регистрация на курс)

## 0) Карта спецификаций
- Flow 1 (этот документ): `/Users/islam/IdeaProjects/Tajwid/startingSpec.md`
  Базовая (нереферальная) регистрация.
- Flow 2: `/Users/islam/IdeaProjects/Tajwid/refFlowSpec.md`
  Выдача персональной реферальной ссылки пользователю-рефереру.
- Flow 3: `/Users/islam/IdeaProjects/Tajwid/referralStartSpec.md`
  Входной этап приглашённого пользователя по реферальной ссылке.
- Flow 4: `/Users/islam/IdeaProjects/Tajwid/referralStart2Spec.md`
  Продолжение регистрации приглашённого после запуска `Следующий шаг`.
- Flow 5: `/Users/islam/IdeaProjects/Tajwid/referralEndSpec.md`
  Конечное начисление и учёт реферальных баллов.

## 1) Область сценария
Этот документ описывает только обычный (нереферальный) Flow 1: от входа пользователя до запуска Flow 2 (`Продолжение реф`).

Что входит в Flow 1:
- проверка подписки на общий Telegram-канал школы;
- согласие на обработку персональных данных;
- фиксация Telegram-профиля (`user_id`, `first_name`) через Telegram Update/API;
- сбор контактных данных (реальное имя `user_name`, возраст, данные о детях, телефон);
- сегментация по уровню чтения;
- выдача ссылки на канал курса;
- проверка подписки на канал курса.

Что не входит в Flow 1:
- логика реферальной ссылки;
- регистрация приглашённого по реферальной ссылке;
- начисление баллов за приглашённых.

## 2) Термины
- Общий канал школы: канал, на который пользователь подписывается в начале.
  `https://t.me/tartil_madrasa`
- Канал курса: канал, на который пользователь подписывается после регистрации.
  `https://t.me/+KdrocizaxglkNzgy`
- Пользователь: Telegram-пользователь, проходящий Flow 1.

## 3) Точка входа
Пользователь попадает в Flow 1 по обычному триггеру `/start`.

Важно:
- реферальный вход `/start <referrer_user_id>` обрабатывается отдельной веткой,
  описанной в `/Users/islam/IdeaProjects/Tajwid/referralStartSpec.md`.

## 4) Основной сценарий (happy path + ветвления)

### Шаг 1. Проверка подписки на общий канал школы
Системное условие: `Подписка на общий канал`.

Если `TRUE` (уже подписан):
- отправить сообщение:
  `Ассаламу алейкум ва рахматуЛлахи ва баракатух!`
  `Вы записываетесь на бесплатный курс по таджвиду в месяц Рамадан.`
- кнопка: `Продолжить`;
- переход к шагу 3.

Если `FALSE` (не подписан):
- отправить сообщение:
  `Ассаламу алейкум ва рахматуЛлахи ва баракатух!`
  `Вы записываетесь на бесплатный курс по таджвиду в месяц Рамадан.`
  `Для участия необходимо сначала подписаться на наш Telegram-канал.`
  `Пожалуйста, подпишитесь на канал и затем нажмите кнопку ниже для продолжения регистрации.`
- кнопки:
  - `Telegram-канал школы` (ссылка на канал школы);
  - `Подписался` (служебная кнопка повторной проверки);
- переход к шагу 2.

### Шаг 2. Повторная проверка подписки на общий канал
При нажатии `Подписался`:
- добавить тег `Нажал на кнопку подписался`;
- повторно проверить условие `Подписка на общий канал`.

Если повторная проверка `TRUE`:
- добавить тег `Подписка с бота`;
- зафиксировать `is_school_channel_subscribed = true`;
- переход к шагу 3.

Если повторная проверка `FALSE`:
- отправить сообщение:
  `Возможно, подписка ещё не оформилась.`
  `Пожалуйста, подпишитесь на Telegram-канал и затем нажмите кнопку снова.`
- кнопки:
  - `Telegram-канал школы` (ссылка на канал школы);
  - `Проверить снова`;
- повторная проверка выполняется после нажатия кнопки `Проверить снова`.

### Шаг 3. Согласие на обработку персональных данных
Отправить сообщение:
`Пусть Аллах облегчит вам обучение.`
`Продолжая работу с ботом, вы даете согласие на обработку персональных данных.`

Кнопка:
- `Продолжить` (явное согласие).

Поведение:
- при нажатии `Продолжить`: `consent_given = true`, переход к шагу 4;
- без нажатия `Продолжить` переход к следующим шагам недоступен.

### Шаг 4. Фиксация Telegram-профиля и сбор имени пользователя
Служебно (без ввода пользователя) получить через Telegram API:
- `user_id` = `from.id` (стабильный идентификатор пользователя);
- `telegram_first_name` = `from.first_name`.

Источник данных:
- при входящем сообщении брать из `update.message.from`;
- при необходимости обновить позже использовать `getChat(chat_id = user_id)`.

Сохранить значения во временный контекст сценария.
Запись в таблице пользователей (`users`) на этом шаге не создавать.

Проверки:
- `user_id` обязателен и уникален.

После успешной фиксации Telegram-профиля отправить сообщение:
`Отлично, продолжаем регистрацию.`
`Укажите ваше имя, пожалуйста.`

Ожидать текстовый ввод и применить валидацию имени:
- строка от 2 до 50 символов;
- допускаются буквы, пробел и дефис;
- цифры и спецсимволы не допускаются.

Если имя валидно:
- сохранить в `{{name}}` и в поле `user_name`;
- переход к шагу 5.

Если имя невалидно:
- показать сообщение:
  `Пожалуйста, укажите корректное имя (2-50 символов, только буквы, пробел, дефис).`
- повторить шаг 4.

### Шаг 5. Сбор возраста
Отправить сообщение:
`Укажите ваш возраст, пожалуйста.`

Ожидать текстовый/числовой ввод и применить валидацию возраста:
- только целое число;
- диапазон от 7 до 100 лет.

Если возраст валиден:
- сохранить в `{{age}}`;
- переход к шагу 6.

Если возраст невалиден:
- показать сообщение:
  `Пожалуйста, укажите корректный возраст числом от 7 до 100.`
- повторить шаг 5.

### Шаг 6. Блок про детей: приветствие и количество детей
После успешной валидации возраста отправить сообщения:
- `Рад знакомству, {{name}}! Идём дальше.`
- `Есть ли у вас дети?`
- `Укажите количество детей числом от 0 до 10.`

Ожидать ввод количества детей и применить валидацию:
- только целое число;
- диапазон от 0 до 10.

Если количество детей валидно и равно `0`:
- сохранить в `{{children_count}}`;
- не задавать вопрос `Изучают ли они Коран`;
- перейти к шагу 9.

Если количество детей валидно и больше `0`:
- сохранить в `{{children_count}}`;
- начать последовательный сбор возрастов детей;
- переход к шагу 7.

Если количество детей невалидно:
- показать сообщение:
  `Пожалуйста, укажите количество детей числом от 0 до 10.`
- повторить шаг 6.

### Шаг 7. Сбор возраста каждого ребёнка
Логика выполняется только если `children_count > 0`.

Порядок:
- запросить возраст `1`-го ребёнка: `Укажите возраст 1-го ребенка.`;
- после валидного ввода перейти к `2`-му ребёнку и так далее до `N = children_count`.

Валидация возраста ребёнка:
- только целое число;
- диапазон от 0 до 100 лет.

Если возраст ребёнка невалиден:
- показать сообщение:
  `Пожалуйста, укажите корректный возраст N-го ребенка числом от 0 до 100.`
- повторить ввод для того же ребёнка.

После успешного ввода возраста последнего ребёнка:
- сохранить агрегированное значение `{{children_ages}}` (строка возраста детей в порядке ввода);
- переход к шагу 8.

### Шаг 8. Вопрос по детям: изучают ли Коран
Логика шага выполняется только если `children_count > 0`.

Отправить вопрос:
`Изучают ли они Коран?`

Кнопки:
- `Да`
- `Нет`

Поведение:
- при выборе `Да` сохранить `{{children_study_quran}} = true`, переход к шагу 9;
- при выборе `Нет` сохранить `{{children_study_quran}} = false`, переход к шагу 9;
- если пользователь вводит текст вместо кнопки, допускается `да/нет` (без учёта регистра);
- при любом другом вводе показать:
  `Пожалуйста, выберите один из вариантов ниже.`
  и повторно показать кнопки `Да` / `Нет`.

Если `children_count = 0`:
- шаг 8 пропускается;
- `{{children_study_quran}}` не заполняется (`null`);
- сразу переход к шагу 9.

### Шаг 9. Сбор телефона
Запросить номер телефона через кнопку `ReplyKeyboardMarkup` с `request_contact = true`.

После получения `message.contact`:
- проверить, что `contact.user_id == user_id` текущего пользователя;
- сохранить `contact.phone_number` в `{{phone}}`.

Если `contact.user_id != user_id`:
- показать сообщение:
  `Пожалуйста, отправьте ваш собственный номер через кнопку в боте.`
- повторить шаг 9.

### Шаг 10. Сегментация по уровню чтения Корана
Отправить вопрос:
`Какой у вас текущий уровень чтения Корана?`

Варианты ответа:
- `Начинаю с нуля`
- `Читаю по слогам`
- `Знаю основы`
- `Читаю с ошибками`
- `Читаю уверенно`

На выбранный вариант добавить одноимённый тег.
Дополнительно сохранить выбранный вариант в `reading_level`.

### Шаг 11. Завершение регистрации и выдача ссылки на канал курса
Перед отправкой финального сообщения завершения регистрации:
- создать запись пользователя в `users` (или выполнить `upsert`) с полным набором собранных полей;
- заполнить в записи:
  - `user_id`, `telegram_first_name`, `user_name`, `age`, `children_count`, `children_ages`, `children_study_quran`, `phone`, `reading_level`;
  - `consent_given = true`;
  - `is_school_channel_subscribed = true`;
  - `is_course_channel_subscribed = false`;
  - `registration_completed = true`;
  - `registration_completed_at = now()`;
  - `referrer_user_id = 0`;
  - `referral_status = not_applicable`;
  - `referral_counted_at = 1970-01-01T00:00:00Z`;
  - `referral_points = 0`.

Отправить сообщение:
`Вы успешно зарегистрированы на курс по таджвиду!`
`Вся информация о занятиях, ссылки и материалы будут публиковаться в Telegram-канале.`
`Пожалуйста, подпишитесь на канал курса и затем нажмите кнопку проверки ниже.`

Кнопки:
- `Канал по курсу` (ссылка на канал курса);
- `Проверить подписку`.

Переход к шагу 12 по кнопке `Проверить подписку`.

### Шаг 12. Проверка подписки на канал курса
Системное условие: `Подписка на канал курса`.

Если `TRUE`:
- обновить существующую запись пользователя по `user_id`;
- зафиксировать `is_course_channel_subscribed = true`;
- добавить тег `Подписка на канал курса подтверждена`;
- переход к шагу 13.

Если `FALSE`:
- отправить сообщение:
  `Похоже, подписка на канал курса ещё не активна.`
  `Подпишитесь на канал курса и нажмите кнопку проверки снова.`
- кнопки:
  - `Канал по курсу` (ссылка на канал курса);
  - `Проверить подписку`;
- повторная проверка выполняется после нажатия кнопки `Проверить подписку`.

Если проверка подписки временно недоступна (ошибка API):
- показать сообщение о временной ошибке;
- оставить пользователя на шаге 12;
- автоматический повтор не запускать, только ручная повторная проверка по кнопке `Проверить подписку`.

### Шаг 13. Передача в следующий сценарий
- действие: запуск автоматизации Flow 2 (`Продолжение реф`).

## 5) Спецификация данных

### 5.1 Карточка пользователя / запись регистрации
Запись пользователя создаётся один раз после завершения анкеты (шаг 11), когда уже собраны имя, возраст, данные по детям, телефон и уровень чтения.

Минимальный набор полей:
- `user_id` (обязательное, уникальное; это `Telegram user.id`, основной идентификатор);
- `telegram_first_name` (из Telegram профиля);
- `user_name` (реальное имя пользователя, вводится на шаге 4);
- `age` (возраст из шага 5);
- `children_count` (количество детей из шага 6, диапазон `0..10`);
- `children_ages` (возраста детей из шага 7, сериализованная строка в порядке ввода; пусто при `children_count = 0`);
- `children_study_quran` (bool, ответ шага 8; `null` при `children_count = 0`);
- `phone` (номер из шага 9);
- `is_school_channel_subscribed` (bool);
- `is_course_channel_subscribed` (bool);
- `consent_given` (bool);
- `registration_completed` (bool);
- `registration_completed_at` (timestamp, NOT NULL; до завершения регистрации хранить `1970-01-01T00:00:00Z`);
- `reading_level` (одно из 5 значений шага 10);
- `referrer_user_id` (NOT NULL; `0` означает отсутствие реферера);
- `referral_status` (`pending` | `counted` | `not_applicable`);
- `referral_counted_at` (timestamp, NOT NULL; до зачёта хранить `1970-01-01T00:00:00Z`);
- `referral_points` (int, по умолчанию `0`);
- `created_at`, `updated_at`.

Для нереферального пути (Flow 1):
- `referrer_user_id = 0`;
- `referral_status = not_applicable`;
- `referral_counted_at = 1970-01-01T00:00:00Z`.

### 5.2 Теги
- `Нажал на кнопку подписался`;
- `Подписка с бота`;
- `Подписка на канал курса подтверждена`;
- один из тегов уровня:
  - `Начинаю с нуля`
  - `Читаю по слогам`
  - `Знаю основы`
  - `Читаю с ошибками`
  - `Читаю уверенно`

### 5.3 Переменные сценария
- `{{name}}` — реальное имя пользователя из шага 4;
- `{{telegram_first_name}}` — `first_name` из Telegram API (шаг 4);
- `{{age}}` — возраст из шага 5;
- `{{children_count}}` — количество детей из шага 6;
- `{{children_ages}}` — возраста детей в порядке ввода из шага 7;
- `{{children_study_quran}}` — ответ `Да/Нет` из шага 8;
- `{{phone}}` — телефон из шага 9.

## 6) Крайние случаи и ожидаемое поведение
- Пользователь не подписан на общий канал:
  повторная проверка по кнопке `Проверить снова` до фактической подписки.
- Пользователь не подписан на канал курса:
  повторная проверка по кнопке `Проверить подписку` до фактической подписки.
- Проверка подписки (любой канал) временно недоступна:
  показывать сообщение об ошибке и кнопку повторной проверки, без автоповтора.
- Пользователь отправил некорректное имя:
  показывать сообщение об ошибке валидации и повторять шаг 4.
- Пользователь отправил некорректный возраст:
  показывать сообщение об ошибке валидации и повторять шаг 5.
- Пользователь отправил некорректное количество детей:
  показывать сообщение об ошибке валидации и повторять шаг 6.
- Пользователь отправил некорректный возраст ребёнка:
  показывать сообщение об ошибке валидации и повторять текущий подшаг шага 7.
- Пользователь отправил некорректный ответ на вопрос `Изучают ли они Коран?`:
  повторно показывать кнопки `Да` / `Нет` на шаге 8.
- Пользователь отправил текст вместо контакта:
  повторно запрашивать номер телефона на шаге 9.
- Пользователь отправил чужой контакт (`contact.user_id != user_id`):
  отклонять контакт и повторять шаг 9.
- Пользователь не нажал кнопку согласия:
  продолжение регистрации недоступно.
- Пользователь прервал диалог и вернулся позже:
  продолжать с последнего незавершённого шага.

## 7) Соответствие логике заказчика (обычный старт)
В этой версии зафиксирована целевая логика обычной регистрации:
1. Бот запускается.
2. Проверяется подписка на общий канал.
3. Пользователь проходит регистрацию и оставляет контакты.
4. Бот выдаёт ссылку на канал курса и проверяет подписку на него.

Реферальная логика вынесена в отдельные спецификации Flow 2-Flow 5.

## 8) Граница текущего ТЗ
Flow 1 завершается запуском автоматизации Flow 2 (`Продолжение реф`).
Связанные спецификации:
- выдача реферальной ссылки: `/Users/islam/IdeaProjects/Tajwid/refFlowSpec.md`;
- вход приглашённого по реферальной ссылке: `/Users/islam/IdeaProjects/Tajwid/referralStartSpec.md`;
- продолжение регистрации приглашённого: `/Users/islam/IdeaProjects/Tajwid/referralStart2Spec.md`;
- финальное начисление и учёт баллов: `/Users/islam/IdeaProjects/Tajwid/referralEndSpec.md`.
