# –°–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è Flow 5 Telegram-–±–æ—Ç–∞ (–ö–æ–Ω–µ—Ü: –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã—Ö –±–∞–ª–ª–æ–≤)

## 0) –ö–∞—Ä—Ç–∞ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–π
- Flow 1: `/Users/islam/IdeaProjects/Tajwid/startingSpec.md`
  –ë–∞–∑–æ–≤–∞—è (–Ω–µ—Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è) —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è.
- Flow 2: `/Users/islam/IdeaProjects/Tajwid/refFlowSpec.md`
  –í—ã–¥–∞—á–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–π —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é-—Ä–µ—Ñ–µ—Ä–µ—Ä—É.
- Flow 3: `/Users/islam/IdeaProjects/Tajwid/referralStartSpec.md`
  –í—Ö–æ–¥–Ω–æ–π —ç—Ç–∞–ø –¥–ª—è –ø—Ä–∏–≥–ª–∞—à—ë–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
- Flow 4: `/Users/islam/IdeaProjects/Tajwid/referralStart2Spec.md`
  –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø—Ä–∏–≥–ª–∞—à—ë–Ω–Ω–æ–≥–æ –∏ –∑–∞–ø—É—Å–∫ —Å–ª–µ–¥—É—é—â–µ–π –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏.
- Flow 5 (—ç—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç): `/Users/islam/IdeaProjects/Tajwid/referralEndSpec.md`
  –ü–æ—Å—Ç-–æ–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –±–∞–ª–ª–æ–≤ –∑–∞ –ø—Ä–∏–≥–ª–∞—à—ë–Ω–Ω—ã—Ö.

## 1) –û–±–ª–∞—Å—Ç—å —Å—Ü–µ–Ω–∞—Ä–∏—è
–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç —Å—Ö–µ–º—É `–ö–æ–Ω–µ—Ü` –≤ —Ü–µ–ª–µ–≤–æ–π –ª–æ–≥–∏–∫–µ –∑–∞–∫–∞–∑—á–∏–∫–∞:
- –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ +1 –±–∞–ª–ª–∞ –ø—Ä–∏–≥–ª–∞—Å–∏–≤—à–µ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é;
- –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á—ë—Ç—á–∏–∫–∞ –±–∞–ª–ª–æ–≤ –≤ –ë–î;
- –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Ç–µ–∫—É—â–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø—Ä–∏–≤–ª–µ—á—ë–Ω–Ω—ã—Ö.

–í–∞–∂–Ω–æ:
- —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ–¥–∞—Ä–∫–æ–≤ —Ç–æ–ø-3 –±–ª–∞–≥–æ—Ç–≤–æ—Ä–∏—Ç–µ–ª—è–º–∏ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤–Ω–µ –¥–∞–Ω–Ω–æ–≥–æ —Ñ–ª–æ—É;
- —Å–æ —Å—Ç–æ—Ä–æ–Ω—ã –±–æ—Ç–∞ –≤ —ç—Ç–æ–º —Ñ–ª–æ—É —Ç—Ä–µ–±—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —É—á—ë—Ç –±–∞–ª–ª–æ–≤.

## 2) –°–≤—è–∑—å —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º–∏ Flow
–í—Ö–æ–¥ –≤ Flow 5 –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∏–∑ Flow 4 (`–ù–∞—á–∞–ª–æ –¥–ª—è —Ä–µ—Ñ–µ—Ä–∞–ª–∞ 2`) –ø–æ—Å–ª–µ —à–∞–≥–∞:
- –ø—Ä–∏–≥–ª–∞—à—ë–Ω–Ω—ã–π –ø–µ—Ä–µ—à—ë–ª –ø–æ –∫–Ω–æ–ø–∫–µ `–ö–∞–Ω–∞–ª –ø–æ –∫—É—Ä—Å—É`;
- –∑–∞—Ç–µ–º –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è `–ö–æ–Ω–µ—Ü` (—ç—Ç–æ—Ç Flow 5).

–ö–æ–Ω—Ç–µ–∫—Å—Ç –Ω–∞ –≤—Ö–æ–¥–µ:
- –∑–∞—á—ë—Ç –ø—Ä–∏–≥–ª–∞—à—ë–Ω–Ω–æ–≥–æ —É–∂–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω;
- –Ω—É–∂–Ω–æ —É–≤–µ–ª–∏—á–∏—Ç—å —Å—á—ë—Ç—á–∏–∫ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤ —É –ø—Ä–∏–≥–ª–∞—Å–∏–≤—à–µ–≥–æ (`referrer`).

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è Flow 5 –≤ Flow 4 –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è Flow 2 (`–ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ —Ä–µ—Ñ`) –¥–ª—è –≤—ã–¥–∞—á–∏ —Å—Å—ã–ª–∫–∏ —É–∂–µ –Ω–æ–≤–æ–º—É —É—á–∞—Å—Ç–Ω–∏–∫—É.

### 2.1 –ö–æ–Ω—Ç—Ä–∞–∫—Ç –≤—Ö–æ–¥–∞ –≤ Flow 5 (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π)
Flow 5 –ø—Ä–∏–Ω–∏–º–∞–µ—Ç payload –∏–∑ Flow 4:
- `referral_event_id` (UUID —Å–æ–±—ã—Ç–∏—è);
- `referrer_user_id` (–∫–æ–≥–æ –Ω—É–∂–Ω–æ –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å);
- `invitee_user_id` (–∫–æ–≥–æ –∑–∞—Å—á–∏—Ç—ã–≤–∞—é—Ç –ø—Ä–∏–≥–ª–∞—à—ë–Ω–Ω—ã–º);
- `idempotency_key = ref:{referrer_user_id}:{invitee_user_id}`;
- `trigger_source` (–æ–¥–Ω–æ –∏–∑ –∑–Ω–∞—á–µ–Ω–∏–π):
  - `flow4_course_link_click` (—Ä—É—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ –∫–Ω–æ–ø–∫–µ);
  - `course_channel_membership_update` (–∞–≤—Ç–æ-–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–æ Telegram membership update);
- `triggered_at` (timestamp).

–ö–æ–Ω—Ç—Ä–∞–∫—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ Flow 5:
- `is_already_counted` (bool):
  - `true` ‚Äî –±–∞–ª–ª –∑–∞—Å—á–∏—Ç–∞–Ω –¥–ª—è –¥–∞–Ω–Ω–æ–π —Å—É—â–Ω–æ—Å—Ç–∏ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–∏;
  - `false` ‚Äî –±–∞–ª–ª –Ω–µ –∑–∞—Å—á–∏—Ç–∞–Ω.

–í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞:
- –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è: `referral_event_id`, `referrer_user_id`, `invitee_user_id`, `idempotency_key`, `trigger_source`, `triggered_at`;
- `referrer_user_id != invitee_user_id` (—Å–∞–º–æ—Ä–µ—Ñ–µ—Ä–∞–ª –∑–∞–ø—Ä–µ—â—ë–Ω);
- `referrer_user_id` –¥–æ–ª–∂–µ–Ω —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å –≤ –ë–î;
- `invitee_user_id` –¥–æ–ª–∂–µ–Ω —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å –≤ –ë–î.

–ï—Å–ª–∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è –Ω–µ –ø—Ä–æ–π–¥–µ–Ω–∞:
- –±–∞–ª–ª—ã –Ω–µ –Ω–∞—á–∏—Å–ª—è—Ç—å;
- –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –Ω–µ—É—Å–ø–µ—à–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ –≤ –ª–æ–≥–∞—Ö/–∞—É–¥–∏—Ç–µ;
- –≤–µ—Ä–Ω—É—Ç—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤ Flow 4 –±–µ–∑ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± —É—Å–ø–µ—à–Ω–æ–º `+1`.

## 3) –û—Å–Ω–æ–≤–Ω–æ–π —Å—Ü–µ–Ω–∞—Ä–∏–π (–ø–æ —Å—Ö–µ–º–µ "–ö–æ–Ω–µ—Ü")

### –®–∞–≥ 1. –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω–æ–≥–æ payload
–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Ç—Ä–∞–∫—Ç –∏–∑ —Ä–∞–∑–¥–µ–ª–∞ `2.1`.

–ï—Å–ª–∏ payload –Ω–µ–≤–∞–ª–∏–¥–µ–Ω:
- –∑–∞–≤–µ—Ä—à–∏—Ç—å Flow 5 –±–µ–∑ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è.

–ï—Å–ª–∏ payload –≤–∞–ª–∏–¥–µ–Ω:
- –ø–µ—Ä–µ–π—Ç–∏ –∫ —à–∞–≥—É 2.

### –®–∞–≥ 2. –ê—Ç–æ–º–∞—Ä–Ω–æ–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ –≤ –ë–î (single transaction)
–ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ –ë–î, –≤–Ω—É—Ç—Ä–∏ –æ–¥–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —Å –ø–µ—Å—Å–∏–º–∏—Å—Ç–∏—á–Ω–æ–π –±–ª–æ–∫–∏—Ä–æ–≤–∫–æ–π.

–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º:
1. `BEGIN`.
2. `SELECT user_id, referral_points FROM users WHERE user_id = :referrer_user_id FOR UPDATE`.
3. `INSERT INTO referral_link_usage (...) VALUES (...)`
   —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º –Ω–∞ –ø–∞—Ä—É `(referrer_user_id, invitee_user_id)` –∏–ª–∏ –Ω–∞ `idempotency_key`.
4. –ï—Å–ª–∏ `INSERT` —É—Å–ø–µ—à–µ–Ω:
   - `UPDATE users SET referral_points = referral_points + 1 WHERE user_id = :referrer_user_id`;
   - —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å `is_already_counted = true`, `counted_at = now()` —É –∑–∞–ø–∏—Å–∏ `referral_link_usage`;
   - –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å `referral_status = counted`, `referral_counted_at = now()` —É –ø—Ä–∏–≥–ª–∞—à—ë–Ω–Ω–æ–≥–æ;
   - —Å—á–∏—Ç–∞—Ç—å –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ `referral_points`;
   - `COMMIT`;
   - –≤–µ—Ä–Ω—É—Ç—å `is_already_counted = true`.
5. –ï—Å–ª–∏ `INSERT` –Ω–µ —Å–æ–∑–¥–∞–ª —Å—Ç—Ä–æ–∫—É (–¥—É–±–ª–∏–∫–∞—Ç):
   - –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∑–∞–ø–∏—Å—å `referral_link_usage` –ø–æ `(referrer_user_id, invitee_user_id)`;
   - `ROLLBACK` –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –ø–æ —Ç–µ–∫—É—â–µ–º—É –≤—ã–∑–æ–≤—É (–±–µ–∑ –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞);
   - –≤–µ—Ä–Ω—É—Ç—å –µ—ë —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ `is_already_counted`.

### –®–∞–≥ 3. –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
`{{referralbonus}}` –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –∏–∑ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –≤ –ë–î `referral_points` –ø–æ—Å–ª–µ `COMMIT`.

–í–∞–∂–Ω–æ:
- –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è `{{referralbonus}}` –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –∏—Å—Ç–æ—á–Ω–∏–∫–æ–º –∏—Å—Ç–∏–Ω—ã;
- –µ—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π —Ä–∞—Å—Ö–æ–¥–∏—Ç—Å—è —Å –ë–î, –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –≤—Å–µ–≥–¥–∞ —É –ë–î.

### –®–∞–≥ 4. –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
–ï—Å–ª–∏ `is_already_counted = true`, –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ:
`+1 –∫ –æ–±—â–µ–π –∫–æ–ø–∏–ª–∫–µ üî•`
`–û–±—â–µ–µ –∫–æ–ª-–≤–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–Ω—ã—Ö –¥—Ä—É–∑–µ–π: {{referralbonus}}`.

–ï—Å–ª–∏ `is_already_counted = false`, –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–º `+1`.
–ü—Ä–∏ —ç—Ç–æ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç `false` –Ω–µ –¥–æ–ª–∂–µ–Ω –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–π —ç—Ç–∞–ø: Flow 4 –º–æ–∂–µ—Ç –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∑–∞–ø—É—Å–∫ Flow 2.

### –®–∞–≥ 5. –°–ª—É–∂–µ–±–Ω—ã–π –∏–Ω—Ñ–æ-–±–ª–æ–∫ –Ω–∞ —Å—Ö–µ–º–µ
–ù–∞ —Å—Ö–µ–º–µ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–π –±–ª–æ–∫ –ø—Ä–æ –ø—Ä–∏–∑—ã.

–í —Ç–µ–∫—É—â–µ–π –ª–æ–≥–∏–∫–µ —ç—Ç–æ —Å–ª—É–∂–µ–±–Ω–∞—è –∑–∞–º–µ—Ç–∫–∞, –Ω–µ –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —à–∞–≥:
- prizes/top-3 –Ω–µ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ —ç—Ç–æ–≥–æ —Ñ–ª–æ—É;
- —Ñ–ª–æ—É —Ç–æ–ª—å–∫–æ –Ω–∞–∫–∞–ø–ª–∏–≤–∞–µ—Ç –±–∞–ª–ª—ã.

## 4) –°–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö

### 4.1 –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –ø–æ–ª—è (—Å—Ç–æ—Ä–æ–Ω–∞ –ë–î)
- `user_id` ‚Äî –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø—Ä–∏–≥–ª–∞—Å–∏–≤—à–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (`Telegram user.id`);
- `referral_points` ‚Äî –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞—Å—á–∏—Ç–∞–Ω–Ω—ã—Ö –ø—Ä–∏–≥–ª–∞—à—ë–Ω–Ω—ã—Ö;
- `updated_at` ‚Äî –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—á—ë—Ç—á–∏–∫–∞.

### 4.2 –¢–∞–±–ª–∏—Ü–∞ —Å–æ–±—ã—Ç–∏–π –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è (–∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å)
`referral_link_usage` (–∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è —Å—É—â–Ω–æ—Å—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–∏):
- `referral_event_id` (UUID, PK);
- `referral_link` (—Å—Ç—Ä–æ–∫–∞ deep-link);
- `referrer_user_id`;
- `invitee_user_id`;
- `idempotency_key` (UNIQUE);
- `is_already_counted` (bool, default `false`);
- `counted_at` (timestamp, NOT NULL; –¥–æ –∑–∞—á—ë—Ç–∞ `1970-01-01T00:00:00Z`, –ø—Ä–∏ –∑–∞—á—ë—Ç–µ –æ–±–Ω–æ–≤–ª—è—Ç—å –Ω–∞ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –≤—Ä–µ–º—è);
- `created_at`.

–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:
- UNIQUE (`referrer_user_id`, `invitee_user_id`) –∏–ª–∏ UNIQUE (`idempotency_key`);
- FK –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.

### 4.3 Source of truth –¥–ª—è –±–∞–ª–ª–æ–≤
- –ò—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã: `users.referral_points` –≤ –ë–î.
- `{{referralbonus}}` ‚Äî –ø—Ä–æ–∏–∑–≤–æ–¥–Ω–∞—è –ø—Ä–æ–µ–∫—Ü–∏—è –¥–ª—è —Ç–µ–∫—Å—Ç–∞ —Å–æ–æ–±—â–µ–Ω–∏—è.
- –õ—é–±—ã–µ UI-–ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–æ–ª–∂–Ω—ã –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞—Ç—å—Å—è –∏–∑ –ë–î –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ `COMMIT`.

## 5) –ö—Ä–∞–π–Ω–∏–µ —Å–ª—É—á–∞–∏
- –ï—Å–ª–∏ `{{referralbonus}}` –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω, –≤–∑—è—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ `users.referral_points` –ø–æ—Å–ª–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏.
- –ï—Å–ª–∏ —Å–æ–±—ã—Ç–∏–µ –ø–æ –ø–∞—Ä–µ `(referrer_user_id, invitee_user_id)` —É–∂–µ –±—ã–ª–æ, –ø–æ–≤—Ç–æ—Ä–Ω–æ–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ –Ω–µ –≤—ã–ø–æ–ª–Ω—è—Ç—å, –≤–µ—Ä–Ω—É—Ç—å —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ `is_already_counted`.
- –ï—Å–ª–∏ `is_already_counted = false`, —Å—á–∏—Ç–∞—Ç—å —ç—Ç–æ –∞–Ω–æ–º–∞–ª–∏–µ–π:
  - –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ –∫–∞–∫ anomaly;
  - –Ω–µ –ø—Ä–µ—Ä—ã–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫—É—é —Ü–µ–ø–æ—á–∫—É.
- –ï—Å–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ë–î –Ω–µ—É—Å–ø–µ—à–Ω–æ, –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–º `+1`.
- –ï—Å–ª–∏ –∫–æ–Ω—Ç—Ä–∞–∫—Ç –∏–∑ Flow 4 –Ω–µ–ø–æ–ª–Ω—ã–π –∏–ª–∏ –±–∏—Ç—ã–π, –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ –Ω–µ –≤—ã–ø–æ–ª–Ω—è—Ç—å.

## 6) –ì—Ä–∞–Ω–∏—Ü–∞ —Ç–µ–∫—É—â–µ–≥–æ –¢–ó
Flow 5 —è–≤–ª—è–µ—Ç—Å—è –∫–æ–Ω–µ—á–Ω–æ–π –ø–æ—Å—Ç-–æ–±—Ä–∞–±–æ—Ç–∫–æ–π –≤ —Ç–µ–∫—É—â–µ–π —Ü–µ–ø–æ—á–∫–µ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤.
–†–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞–±–æ—Ç—ã Flow 5:
- –≤ –ë–î –∞—Ç–æ–º–∞—Ä–Ω–æ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–æ —Å–æ–±—ã—Ç–∏–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è;
- –≤ –ë–î –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–æ –∞–∫—Ç—É–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–∞–ª–ª–æ–≤ –ø—Ä–∏–≥–ª–∞—Å–∏–≤—à–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (`source of truth`);
- –≤ Flow 4 –º–æ–∂–Ω–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç—å –∫ –∑–∞–ø—É—Å–∫—É Flow 2.
